# ThunderDuck 全面性能基准测试报告

> **测试日期**: 2026-01-27 (更新)
> **测试平台**: Apple M4 Max | macOS 14.x
> **版本标签**: V11 - Hash Join SIMD加速版 + 并行优化

## 最新优化结果

### Hash Join - 成功超越 DuckDB

| 版本 | 时间(ms) | vs DuckDB | 说明 |
|------|---------|-----------|------|
| DuckDB | 4.71 | 1.00x | 基准 |
| **V7(自适应)** | 3.92 | **1.20x** | 最优 - 自适应策略 |
| **V11(SIMD简化)** | 4.12 | **1.14x** | 三级预取 + 8路展开 |
| V11(SIMD并行) | 4.70 | 1.00x | 并行槽位比较 |
| V6(预取优化) | 4.64 | 1.02x | 激进预取 |

### 新增并行优化

| 优化项 | 文件 | 说明 |
|--------|------|------|
| GPU GROUP BY V3 | `group_aggregate_v3.metal` | Warp-level reduction |
| 并行 Filter | `simd_filter_parallel.cpp` | 4线程并行 SIMD |
| 并行 Aggregate | `simd_aggregate_parallel.cpp` | 4线程并行归约 |

---

## 一、测试环境

| 项目 | 配置 |
|------|------|
| **CPU** | Apple M4 Max (12核 性能核 + 4核 能效核) |
| **GPU** | 集成 40核 GPU |
| **NPU** | 16核 Neural Engine |
| **内存** | 统一内存架构 (UMA), L1=192KB, L2=16MB |
| **预热轮数** | 2 |
| **测试轮数** | 5 (取平均值) |
| **编译器** | clang++ -O3 -mcpu=native -march=armv8-a+crc |

---

## 二、各算子详细性能报告

### 2.1 FILTER 算子

**SQL 等价**: `SELECT COUNT(*) FROM t WHERE value > 500000`

#### 1M 数据 (3.8 MB)

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 0.279 | 13.3 | 1.00x | 0.14x | 基准 |
| **V3** | CPU SIMD | 0.039 | 95.0 | **7.13x** | 1.00x | - |
| V7 | GPU | 0.035 | 106.0 | **7.95x** | 1.12x | - |
| **V8** | CPU SIMD | 0.032 | 114.7 | **8.60x** | 1.21x | 最优 |
| V9 | CPU SIMD | 0.033 | 114.4 | **8.58x** | 1.20x | - |

#### 10M 数据 (38 MB)

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 1.488 | 25.0 | 1.00x | 0.38x | 基准 |
| **V3** | CPU SIMD | 0.571 | 65.3 | **2.61x** | 1.00x | 最优 |
| V7 | GPU | 0.627 | 59.4 | 2.37x | 0.91x | GPU开销 |
| V8 | CPU SIMD | 0.573 | 65.0 | 2.60x | 1.00x | - |
| V9 | CPU SIMD | 0.677 | 55.1 | 2.20x | 0.84x | 回退 |

**分析**:
- 小数据(1M): V8 最优，SIMD 向量化达到 **8.6x** 加速
- 大数据(10M): V3 最优，稳定 **2.6x** 加速
- GPU (V7) 在大数据时有 PCIe 传输开销，性能下降

**优化建议**:
- 大数据场景可考虑多线程并行 SIMD
- 探索 GPU 零拷贝优化

---

### 2.2 AGGREGATE 算子

**SQL 等价**: `SELECT SUM(value) FROM t`

#### 1M 数据 (3.8 MB)

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 0.244 | 15.3 | 1.00x | 0.18x | 基准 |
| **V3** | CPU SIMD | 0.043 | 86.9 | **5.69x** | 1.00x | - |
| V7 | GPU | 0.043 | 87.3 | **5.72x** | 1.00x | - |
| V9 | CPU SIMD | 0.043 | 86.6 | **5.68x** | 1.00x | - |

#### 10M 数据 (38 MB)

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 1.709 | 21.8 | 1.00x | 0.32x | 基准 |
| V3 | CPU SIMD | 0.541 | 68.9 | **3.16x** | 1.00x | - |
| **V7** | GPU | 0.512 | 72.7 | **3.33x** | 1.06x | 最优 |
| V9 | CPU SIMD | 0.581 | 64.1 | 2.94x | 0.93x | - |

**分析**:
- 稳定 **3-6x** 加速，主要得益于 SIMD 向量化
- GPU 在大数据时有轻微优势 (1.06x vs CPU)

**优化建议**:
- 可增加多线程并行，预期提升 2-3x
- 探索 vDSP/BNNS 加速

---

### 2.3 GROUP BY 算子

**SQL 等价**: `SELECT group_id, SUM(value) FROM t GROUP BY group_id`

#### 1M 数据, 1000 分组

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 0.582 | 12.8 | 1.00x | 0.49x | 基准 |
| V7 | CPU 单线程 | 0.283 | 26.3 | **2.06x** | 1.00x | - |
| **V8** | CPU 4核 | 0.146 | 51.2 | **4.00x** | 1.94x | 最优 |
| V9 | GPU | 0.804 | 9.3 | 0.72x | 0.35x | GPU 开销大 |
| V9.3 | AUTO | 0.151 | 49.3 | **3.85x** | 1.87x | - |

#### 10M 数据, 1000 分组

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 2.618 | 28.5 | 1.00x | 1.06x | 基准 |
| V7 | CPU 单线程 | 2.774 | 26.9 | 0.94x | 1.00x | - |
| V8 | CPU 4核 | 1.491 | 50.0 | **1.76x** | 1.86x | - |
| V9 | GPU | 3.036 | 24.5 | 0.86x | 0.91x | GPU 效率低 |
| **V9.3** | AUTO | 1.197 | 62.2 | **2.19x** | 2.32x | 最优 |

**分析**:
- **GPU GROUP BY 性能差**: 10M 数据仅 0.86x，原因是原子操作瓶颈
- **V9.3 智能策略**效果最好，自动选择 CPU 多线程

**优化建议**:
- GPU GROUP BY 需要重新设计，考虑分区聚合
- 增大 GPU 阈值，避免不必要的 GPU 调用

---

### 2.4 TopK 算子

**SQL 等价**: `SELECT * FROM t ORDER BY value DESC LIMIT 10`

#### 1M 数据, K=10

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 1.283 | 2.9 | 1.00x | 0.37x | 基准 |
| V3 | CPU Heap | 0.473 | 7.9 | 2.71x | 1.00x | - |
| V7 | CPU SIMD 采样 | 0.065 | 56.9 | **19.6x** | 7.22x | - |
| **V8** | CPU 计数 | 0.061 | 60.8 | **20.9x** | 7.71x | 最优 |
| V9 | CPU | 0.063 | 58.9 | **20.3x** | 7.47x | - |

#### 10M 数据, K=10

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 5.960 | 6.3 | 1.00x | 0.80x | 基准 |
| V3 | CPU Heap | 4.770 | 7.8 | 1.25x | 1.00x | - |
| V7 | CPU SIMD 采样 | 1.754 | 21.2 | **3.40x** | 2.72x | - |
| V8 | CPU 计数 | 1.453 | 25.6 | **4.10x** | 3.28x | - |
| **V9** | CPU | 1.162 | 32.1 | **5.13x** | 4.10x | 最优 |

**分析**:
- **TopK 表现最优**: 小数据 20x+，大数据 5x+
- V8 计数排序算法避免了完整排序开销

**优化建议**:
- 已达到接近理论最优
- 可探索 GPU 并行选择，但收益有限

---

### 2.5 HASH JOIN 算子 (重点)

**SQL 等价**: `SELECT * FROM build_t INNER JOIN probe_t ON build_t.key = probe_t.key`

#### 场景: 100K build × 1M probe, ~10% 匹配率

**数据量**: 4.2 MB (100K × 4B + 1M × 4B)

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|---------|-----------|-----------|-------|------|
| DuckDB | CPU | 3.95 | 1.06 | 1.00x | 0.77x | 基准 |
| V3 | CPU SIMD 分区 | 5.13 | 0.82 | 0.77x | 1.00x | - |
| **V7** | CPU/GPU 自适应 | 3.82 | 1.10 | **1.04x** | 1.34x | 超越DuckDB |
| V10 | CPU SIMD | 5.53 | 0.76 | 0.71x | 0.93x | - |
| V6 | CPU 预取优化 | 5.67 | 0.74 | 0.70x | 0.90x | - |
| V10.1 | CPU 零拷贝 | 5.32 | 0.79 | 0.74x | 0.96x | 失败实验 |
| V10.2 | CPU 单哈希 | 5.79 | 0.72 | 0.68x | 0.88x | 失败实验 |
| **V11** | CPU SIMD简化 | 3.69 | 1.14 | **1.07x** | 1.39x | **最优** |
| V11 | CPU SIMD并行 | 4.19 | 1.00 | 0.94x | 1.22x | - |

#### Hash Join 5次测试详情 (V11 SIMD简化)

| 测试 | DuckDB(ms) | V11(ms) | vs DuckDB |
|------|-----------|---------|-----------|
| Run 1 | 4.11 | 3.76 | **1.09x** |
| Run 2 | 4.23 | 3.80 | **1.11x** |
| Run 3 | 4.04 | 3.55 | **1.14x** |
| Run 4 | 3.68 | 3.66 | **1.00x** |
| Run 5 | 3.79 | 3.70 | **1.03x** |
| **平均** | 3.97 | 3.69 | **1.07x** |

**V11 关键优化**:
1. **负载因子 0.33** - 3x 容量，大幅减少哈希冲突
2. **三级预取策略** - L1 预取 probe keys + 哈希表位置，L2 远距离预取
3. **预取距离 24** - 充分隐藏内存延迟 (~80 cycles)
4. **8路循环展开** - 减少循环开销和分支预测失败

**分析**:
- V11 SIMD简化版平均 **1.07x** 超越 DuckDB
- V7 自适应策略也达到 **1.04x**
- 零拷贝(V10.1)和单哈希(V10.2)实验失败，证明数据拷贝改善缓存局部性

**优化建议**:
- 继续优化分区策略，针对不同数据分布自适应
- 探索 GPU Metal 并行 probe

---

### 2.6 SEMI JOIN 算子

**SQL 等价**: `SELECT * FROM probe_t WHERE key IN (SELECT key FROM build_t)`

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | 状态 |
|------|------|---------|-----------|-----------|------|
| DuckDB | CPU | 3.93 | 1.04 | 1.00x | 基准 |
| **V7** | CPU | 3.65 | 1.12 | **1.08x** | 最优 |
| V10 | CPU | 5.19 | 0.79 | 0.76x | 劣化 |

**分析**: V10 的 SEMI JOIN 优化反而变慢，需要回退到 V7

---

### 2.7 Range Join 特殊算子

**场景**: 100K left × 1K ranges 范围连接

| 方法 | 时间(ms) | 加速比 |
|------|---------|--------|
| Range(标量) | 66.8 | 1.00x |
| **Range(SIMD)** | 30.6 | **2.18x** |

---

## 三、版本性能汇总

### 3.1 vs DuckDB 平均加速比

| 版本 | 平均加速比 | 适用场景 |
|------|-----------|----------|
| **V8(计数)** | **12.5x** | TopK (小K值) |
| **V7(采样)** | **11.5x** | TopK (采样优化) |
| V9(GPU) | 6.8x | TopK 大数据 |
| V8 | 5.6x | Filter 小数据 |
| V9 | 4.9x | 通用 |
| V7(GPU) | 4.8x | Filter 小数据 |
| V3 | 3.3x | Filter/Aggregate |
| V9.3(智能) | 3.0x | GROUP BY |
| V8(并行) | 2.9x | GROUP BY |
| V7(单线程) | 1.5x | GROUP BY 单线程 |
| **V11(SIMD简化)** | **1.07x** | **Hash Join** |
| V7(自适应) | 1.04x | Hash Join |
| V11(SIMD并行) | 0.94x | Hash Join |
| V6(预取优化) | 0.71x | Hash Join (失败) |
| V10.2(单哈希) | 0.69x | Hash Join (失败) |

### 3.2 各算子最优版本

| 算子 | 最优版本 | vs DuckDB | 执行设备 |
|------|---------|-----------|----------|
| Filter (1M) | V8 | 8.6x | CPU SIMD |
| Filter (10M) | V3 | 2.6x | CPU SIMD |
| Aggregate (1M) | V7 | 5.7x | GPU |
| Aggregate (10M) | V7 | 3.3x | GPU |
| GROUP BY (1M) | V8 | 4.0x | CPU 4核 |
| GROUP BY (10M) | V9.3 | 2.2x | AUTO |
| TopK (1M) | V8 | 20.9x | CPU 计数 |
| TopK (10M) | V9 | 5.1x | CPU |
| **Hash Join** | **V11** | **1.07x** | **CPU SIMD** |
| SEMI Join | V7 | 1.08x | CPU |

---

## 四、待优化点分析

### 4.1 红色区域 (性能劣于 DuckDB)

| 算子 | 版本 | 当前性能 | 问题根因 | 优化方向 |
|------|------|---------|---------|----------|
| GROUP BY 10M | V9(GPU) | 0.86x | 原子操作瓶颈 | 分区聚合 + Warp-level reduction |
| Hash Join | V10.2 | 0.69x | 哈希缓存增加内存压力 | 废弃 |
| SEMI Join | V10 | 0.76x | 位图检查开销 | 回退 V7 |

### 4.2 黄色区域 (可进一步优化)

| 算子 | 版本 | 当前性能 | 优化潜力 | 优化方向 |
|------|------|---------|---------|----------|
| Filter 10M | V3 | 2.6x | 4-5x | 多线程并行 |
| Aggregate 10M | V7 | 3.3x | 5-6x | 多线程 + vDSP |
| Hash Join | V11 | 1.07x | 1.2-1.5x | SIMD gather/更好分区 |

### 4.3 绿色区域 (已优化到位)

| 算子 | 版本 | 性能 | 说明 |
|------|------|-----|------|
| Filter 1M | V8 | 8.6x | 接近内存带宽上限 |
| TopK | V8 | 20.9x | 计数排序最优 |
| Aggregate 1M | V3 | 5.7x | SIMD 向量化饱和 |

---

## 五、优化优先级建议

### P0 - 紧急 (性能劣于 DuckDB)

1. **GPU GROUP BY 重新设计**
   - 当前: 0.86x
   - 目标: 2.0x+
   - 方案: 两阶段聚合 (分区 → 合并)

### P1 - 高优先级 (有明显提升空间)

2. **Filter 10M 多线程**
   - 当前: 2.6x
   - 目标: 4-5x
   - 方案: 4 线程 SIMD 并行

3. **Aggregate 10M 多线程**
   - 当前: 3.3x
   - 目标: 5-6x
   - 方案: vDSP + 多线程

### P2 - 中优先级 (锦上添花)

4. **Hash Join 分区优化**
   - 当前: 1.07x
   - 目标: 1.2-1.5x
   - 方案: 自适应分区大小 + 更优预取

---

## 六、结论

1. **整体优势**: 大部分算子达到 **3-20x** 加速比
2. **Hash Join 突破**: V11 成功超越 DuckDB (**1.07x**)
3. **TopK 最优**: 计数排序达到 **20x** 加速
4. **GPU 短板**: GROUP BY 原子操作瓶颈待解决
5. **优化方向明确**: 多线程并行是下一步重点

---

## 附录: 版本说明

| 版本 | 标签 | 核心技术 |
|------|------|----------|
| V3 | 基础分区版 | Radix 16分区 + SIMD |
| V6 | 预取优化版 | 激进预取 (失败实验) |
| V7 | 自适应版 | 完美哈希 + GPU + Bloom |
| V8 | 并行版 | 多线程 + 计数排序 |
| V9 | GPU版 | Metal compute shader |
| V9.3 | 智能版 | 运行时策略选择 |
| V10 | 统一版 | SEMI/ANTI 优化 |
| V10.1 | 零拷贝版 | 间接访问 (失败实验) |
| V10.2 | 单哈希版 | 哈希缓存 (失败实验) |
| **V11** | **SIMD加速版** | **三级预取 + 低负载因子 + 8路展开** |
