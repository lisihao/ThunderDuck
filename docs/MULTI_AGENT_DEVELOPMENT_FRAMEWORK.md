# Claude Code 多 Agent 开发框架 v3.0

> 版本: 3.0 | 日期: 2026-01-28 | 核心改进: 自动调度、努力程度控制、错误恢复

## 一、设计理念

### 1.1 核心原则：用户是领导

```
┌──────────────────────────────────────────────────────────────┐
│                        用户 (领导)                            │
│                     只需描述需求                              │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────┐
│                   Coordinator (我)                            │
│                                                               │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                 自动执行流程                          │   │
│   │  1. 分析任务复杂度                                    │   │
│   │  2. 自动拆解为子任务                                  │   │
│   │  3. 自动分配给合适的 Agent                            │   │
│   │  4. 自动并行执行独立任务                              │   │
│   │  5. 自动汇总结果向用户报告                            │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                               │
│   ❌ 禁止：让用户手动调用 Task(agent=xxx)                    │
└──────────────────────────────────────────────────────────────┘
```

### 1.2 与 v2.0 的区别

| 维度 | v2.0 | v3.0 |
|------|------|------|
| 调度方式 | 用户手动 `Task(agent=xxx)` | **自动调度** |
| 任务分析 | 无 | **自动判断复杂度** |
| 资源控制 | 无 | **努力程度规则** |
| 错误处理 | 依赖内置 | **检查点 + 回滚** |
| 工具加载 | 全量加载 | **渐进式暴露** |
| 用户交互 | 多次确认 | **关键节点汇报** |

## 二、自动调度系统

### 2.1 复杂度判断标准

| 复杂度 | 特征 | 处理方式 |
|--------|------|----------|
| **简单** | 单文件、明确操作、<50行改动 | 直接执行，不调用 Agent |
| **中等** | 多文件、需要分析、50-500行 | 串行调用 1-2 个 Agent |
| **复杂** | 跨模块、需要设计、>500行 | 并行调用 3+ 个 Agent |

### 2.2 自动调度决策树

```
用户输入需求
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│                    Coordinator 分析                          │
├─────────────────────────────────────────────────────────────┤
│  1. 解析需求关键词                                           │
│  2. 估算影响范围 (文件数、代码行数)                          │
│  3. 判断是否需要架构评审                                     │
│  4. 确定复杂度等级                                           │
└─────────────────────────────────────────────────────────────┘
         │
    ┌────┴────┬────────────┐
    ▼         ▼            ▼
 [简单]    [中等]       [复杂]
    │         │            │
    ▼         ▼            ▼
 直接执行   串行调度     并行调度
 0 Agent   1-2 Agent    3+ Agent
```

### 2.3 Agent 自动触发条件

| 条件 | 自动调用 | 说明 |
|------|----------|------|
| 涉及 3+ 模块或新增核心组件 | **Architect** | 架构评审 |
| 代码实现完成 | **Tester** | 自动测试 |
| 准备提交代码 | **Reviewer** | 代码审查 |
| 功能完成 | **Docs** | 更新文档 |
| 涉及构建/部署 | **Ops** | 构建验证 |
| 任务结束 | **Secretary** | 记录评估 |
| 新功能验收 | **PM** | 产品把关 |

## 三、努力程度规则

### 3.1 资源限制矩阵

| 复杂度 | 最大 Token | 最大 Agent | 最大迭代 | 超时 |
|--------|-----------|-----------|---------|------|
| **简单** | 5K | 0 | 1 | 2分钟 |
| **中等** | 30K | 2 | 3 | 10分钟 |
| **复杂** | 100K | 5 | 5 | 30分钟 |

### 3.2 过度投入检测

检测到以下情况时，**立即暂停并报告**：

- 同一文件修改超过 3 次
- 同一测试失败超过 3 次
- 搜索/阅读文件超过 20 个
- 子任务生成超过 10 个

### 3.3 自动降级规则

```
IF 接近资源限制 (80%) THEN:
  1. 汇总当前进展
  2. 报告给用户
  3. 询问是否继续或调整方向

IF 超出资源限制 THEN:
  1. 立即停止
  2. 保存状态检查点
  3. 报告已完成部分和剩余工作
```

## 四、错误恢复机制

### 4.1 状态检查点

```
.claude/checkpoints/
├── session_<id>.json           # 会话状态
│   ├── completed_tasks         # 已完成任务
│   ├── pending_tasks           # 待执行任务
│   ├── modified_files          # 已修改文件
│   └── rollback_info           # 回滚信息
└── checkpoint_<timestamp>/     # 文件快照
    └── <modified_files>        # 修改前副本
```

### 4.2 回滚机制

```
IF 任务失败 THEN:
  1. 读取最近检查点
  2. 恢复到上一个成功状态
  3. 尝试替代方案
  4. 如果仍失败，报告用户并提供选项
```

用户可用命令：
- "回滚到上一步" → 恢复上一个检查点
- "回滚所有修改" → 恢复到任务开始前

### 4.3 错误重试策略

| 错误类型 | 重试次数 | 失败后动作 |
|----------|---------|-----------|
| 网络错误 | 3 | 报告用户 |
| 编译错误 | 2 | 尝试修复 |
| 测试失败 | 2 | 分析原因 |
| 工具超时 | 1 | 换方案 |

## 五、渐进式工具暴露

### 5.1 四阶段工具加载

```
阶段 1: 分析阶段 (只读)
├── Read, Glob, Grep, LSP
└── 目的: 理解代码，分析问题

阶段 2: 规划阶段 (规划)
├── TodoWrite, AskUserQuestion
└── 目的: 制定计划，确认方案

阶段 3: 执行阶段 (写入)
├── Edit, Write, Bash
└── 目的: 实施修改，执行命令

阶段 4: 验证阶段 (验证)
├── Bash (test), Read
└── 目的: 运行测试，验证结果
```

### 5.2 工具使用优先级

```
优先使用专用工具：

查找文件 → Glob    (不用 find)
搜索内容 → Grep    (不用 grep/rg)
读取文件 → Read    (不用 cat/head/tail)
编辑文件 → Edit    (不用 sed/awk)
创建文件 → Write   (不用 echo/cat)
```

## 六、三层九角色架构

### 6.1 架构图

```
┌──────────────────────────────────────────────────────────────┐
│                         用户 (领导)                           │
└──────────────────────────┬───────────────────────────────────┘
                           │
┌──────────────────────────▼───────────────────────────────────┐
│                    Coordinator (自动调度)                     │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ════════════════════ 决策层 ════════════════════            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │Architect │  │    PM    │  │Secretary │                   │
│  │ (Opus)   │  │ (Opus)   │  │(Sonnet)  │                   │
│  └──────────┘  └──────────┘  └──────────┘                   │
│   架构把关       产品把关       记录评估                       │
│                                                               │
│  ════════════════════ 执行层 ════════════════════            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │  Coder   │  │  Tester  │  │ Reviewer │                   │
│  │(Sonnet)  │  │(Sonnet)  │  │(Sonnet)  │                   │
│  └──────────┘  └──────────┘  └──────────┘                   │
│   代码实现       测试验证       代码审查                       │
│                                                               │
│  ════════════════════ 支撑层 ════════════════════            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │   Docs   │  │   Ops    │  │  Guard   │                   │
│  │(Sonnet)  │  │(Sonnet)  │  │ (Haiku)  │                   │
│  └──────────┘  └──────────┘  └──────────┘                   │
│   文档更新       构建部署       质量门禁                       │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 6.2 角色职责

| 层级 | 角色 | 模型 | 职责 | 触发条件 |
|------|------|------|------|----------|
| **决策** | Architect | Opus | 架构设计、技术评审 | 涉及 3+ 模块 |
| **决策** | PM | Opus | 产品竞争力、功能验收 | 功能完成后 |
| **决策** | Secretary | Sonnet | 记录整理、Agent 评估 | 任务结束后 |
| **执行** | Coder | Sonnet | 代码实现、重构 | 复杂编码任务 |
| **执行** | Tester | Sonnet | 测试编写、执行 | 代码变更后 |
| **执行** | Reviewer | Sonnet | 代码审查、安全检查 | 准备提交前 |
| **支撑** | Docs | Sonnet | 文档生成、更新 | 功能完成后 |
| **支撑** | Ops | Sonnet | 构建、部署、基准测试 | 需要验证时 |
| **支撑** | Guard | Haiku | 规范检查、质量门禁 | Hook 自动 |

## 七、标准工作流程

### 7.1 简单任务

```
用户需求 ──▶ 直接执行 ──▶ 验证结果 ──▶ 报告完成
```

### 7.2 中等任务

```
用户需求
    │
    ▼
分析 + 规划 (TodoWrite)
    │
    ▼
┌───────────────────────┐
│ 逐步执行 + 检查点保存  │
└───────────┬───────────┘
            │
     ┌──────┴──────┐
     ▼             ▼
  验证成功      遇到问题
     │             │
     ▼             ▼
  报告完成     恢复 + 重试
```

### 7.3 复杂任务

```
用户需求
    │
    ▼
[Architect] 架构评审
    │
    ▼
分解子任务 + 创建检查点
    │
    ┌─────┼─────┐
    ▼     ▼     ▼
  子任务 子任务 子任务  ← 可并行
    │     │     │
    └─────┼─────┘
          │
     ┌────┴────┐
     ▼         ▼
 [Tester]  [Docs]   ← 并行
     └────┬────┘
          │
          ▼
     [Reviewer]
          │
          ▼
       [PM] 验收
          │
          ▼
     [Secretary] 记录
          │
          ▼
       报告完成
```

## 八、汇报规范

### 8.1 任务完成汇报

```markdown
## 任务完成

**需求**: <用户原话>
**复杂度**: 简单/中等/复杂
**调用 Agent**: <列表或"无">

### 完成内容
1. ...

### 修改文件
- `path/file.cpp` - 说明

### 验证结果
- [x] 编译通过
- [x] 测试通过
```

### 8.2 问题报告

```markdown
## 遇到问题

**问题描述**: ...
**已尝试**: ...
**建议方案**:
1. 方案A: ...
2. 方案B: ...

请选择或提供指示。
```

## 九、配置文件位置

```
~/.claude/
├── CLAUDE.md              # 全局规范 v3.0 ✅
├── settings.json          # Hooks 配置
├── agents/                # 9 个 Agent 定义
├── skills/                # 7 个 Skill
├── rules/                 # 4 个规则文件
└── hooks/                 # 4 个 Hook 脚本
```

## 十、与业界对比

| 维度 | 业界最佳实践 | 我们 v3.0 |
|------|--------------|-----------|
| 自动调度 | OpenAI Swarm | ✅ 自动调度决策树 |
| 努力程度控制 | Anthropic 研究系统 | ✅ 资源限制矩阵 |
| 错误恢复 | LangGraph | ✅ 检查点 + 回滚 |
| 角色专业化 | CrewAI, MetaGPT | ✅ 三层九角色 |
| 渐进式工具 | Agent Design Patterns | ✅ 四阶段加载 |
| 评估系统 | 业界少有 | ✅ Secretary 评估 |

---

*Claude Code 多 Agent 开发框架 v3.0 - 自动调度版*
