# ThunderDuck 需求文档

> **版本**: 3.0 | **日期**: 2026-01-24
>
> 定义 ThunderDuck 项目的功能需求和性能需求

---

## 一、项目概述

### 1.1 项目目标

ThunderDuck 旨在为 Apple Silicon M4 芯片提供高性能的数据库算子实现，通过深度利用硬件特性（ARM Neon SIMD、缓存架构）超越 DuckDB 的默认实现。

### 1.2 核心价值

| 价值 | 描述 |
|------|------|
| **性能** | 在所有核心算子上超越 DuckDB |
| **专用优化** | 针对 M4 芯片特性深度优化 |
| **兼容性** | 作为 DuckDB 的可替换后端 |
| **可维护性** | 清晰的代码结构和文档 |

---

## 二、功能需求

### 2.1 算子需求

#### FR-001: Filter 算子

| 需求ID | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| FR-001.1 | 支持比较操作 (GT, GE, LT, LE, EQ, NE) | P0 | ✅ 已实现 |
| FR-001.2 | 支持 int32 数据类型 | P0 | ✅ 已实现 |
| FR-001.3 | 支持 float32 数据类型 | P1 | ✅ 已实现 |
| FR-001.4 | 支持范围过滤 (BETWEEN) | P0 | ✅ 已实现 |
| FR-001.5 | 支持复合条件 (AND/OR) | P1 | ✅ 已实现 |
| FR-001.6 | 提供纯计数版本 (不输出索引) | P0 | ✅ 已实现 |
| FR-001.7 | 支持位图输出模式 | P2 | ✅ 已实现 |

#### FR-002: Aggregation 算子

| 需求ID | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| FR-002.1 | 支持 SUM 聚合 | P0 | ✅ 已实现 |
| FR-002.2 | 支持 MIN/MAX 聚合 | P0 | ✅ 已实现 |
| FR-002.3 | 支持 AVG 聚合 | P0 | ✅ 已实现 |
| FR-002.4 | 支持 COUNT(*) | P0 | ✅ 已实现 |
| FR-002.5 | 合并的 minmax 函数 (单次遍历) | P0 | ✅ 已实现 |
| FR-002.6 | 支持 GROUP BY | P2 | ⏳ 计划中 |

#### FR-003: Sort 算子

| 需求ID | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| FR-003.1 | 支持升序排序 (ASC) | P0 | ✅ 已实现 |
| FR-003.2 | 支持降序排序 (DESC) | P0 | ✅ 已实现 |
| FR-003.3 | 支持 int32 数据类型 | P0 | ✅ 已实现 |
| FR-003.4 | Radix Sort 实现 (O(n)) | P0 | ✅ 已实现 |
| FR-003.5 | 小数组回退到 std::sort | P1 | ✅ 已实现 |
| FR-003.6 | 并行排序 | P2 | ⏳ 计划中 |

#### FR-004: TopK 算子

| 需求ID | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| FR-004.1 | 支持 Top-K 最大值 | P0 | ✅ 已实现 |
| FR-004.2 | 支持 Top-K 最小值 | P0 | ✅ 已实现 |
| FR-004.3 | 堆选择算法 (K <= 100) | P0 | ✅ 已实现 |
| FR-004.4 | nth_element 策略 (K > 100) | P1 | ✅ 已实现 |
| FR-004.5 | K 值自适应策略 | P1 | ⏳ v3.0 计划 |

#### FR-005: Join 算子

| 需求ID | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| FR-005.1 | 支持 Hash Join | P0 | ✅ 已实现 |
| FR-005.2 | Robin Hood 哈希表 | P1 | ✅ 已实现 |
| FR-005.3 | 分区 Hash Join | P1 | ⏳ 计划中 |
| FR-005.4 | SIMD 批量探测 | P2 | ⏳ 计划中 |

### 2.2 基础设施需求

| 需求ID | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| FR-100.1 | 128 字节对齐内存分配器 | P0 | ✅ 已实现 |
| FR-100.2 | 软件预取支持 | P0 | ✅ 已实现 |
| FR-100.3 | 平台检测 (M4 特性) | P1 | ✅ 已实现 |
| FR-100.4 | DuckDB Extension 接口 | P2 | ⏳ 计划中 |

---

## 三、性能需求

### 3.1 v2.0 性能目标 (已达成)

| 需求ID | 算子 | 目标 | 实际结果 | 状态 |
|--------|------|------|----------|------|
| PR-001 | Aggregation 总体胜率 | ≥75% | **100%** | ✅ 超额完成 |
| PR-002 | Sort 总体胜率 | ≥75% | **100%** | ✅ 超额完成 |
| PR-003 | TopK 总体胜率 | ≥75% | 66% | ⚠️ 部分达成 |
| PR-004 | Filter 总体胜率 | ≥50% | 50% | ✅ 达成 |
| PR-005 | 总体胜率 | ≥60% | **71%** | ✅ 超额完成 |

### 3.2 v3.0 性能目标

| 需求ID | 算子 | 当前 | 目标 | 优先级 |
|--------|------|------|------|--------|
| PR-101 | Filter 总体胜率 | 50% | **100%** | P0 |
| PR-102 | TopK 总体胜率 | 66% | **100%** | P1 |
| PR-103 | 总体胜率 | 71% | **86%+** | P0 |

### 3.3 具体性能指标

#### Filter 性能目标

| 测试 | v2 当前 | v3 目标 | DuckDB 基准 |
|------|---------|---------|-------------|
| F1 (GT) | 0.984 ms | **<0.75 ms** | 0.854 ms |
| F2 (EQ) | 0.975 ms | **<0.70 ms** | 0.823 ms |
| F3 (Range) | 0.699 ms | **<0.60 ms** | 1.014 ms |
| F4 (High Sel) | 1.090 ms | **<0.90 ms** | 1.182 ms |

#### TopK 性能目标

| 测试 | v2 当前 | v3 目标 | DuckDB 基准 |
|------|---------|---------|-------------|
| T1 (K=10) | 0.461 ms | 保持 | 1.134 ms |
| T2 (K=100) | 0.503 ms | 保持 | 1.386 ms |
| T3 (K=1000) | 3.154 ms | **<1.8 ms** | 2.092 ms |

### 3.4 资源约束

| 需求ID | 约束 | 限制值 |
|--------|------|--------|
| PR-200 | 额外内存开销 | ≤20% |
| PR-201 | 二进制大小增加 | ≤1 MB |
| PR-202 | 编译时间增加 | ≤30% |

---

## 四、非功能需求

### 4.1 兼容性需求

| 需求ID | 描述 | 目标 |
|--------|------|------|
| NFR-001 | macOS 版本支持 | 14.0+ |
| NFR-002 | Apple Silicon 支持 | M1/M2/M3/M4 |
| NFR-003 | DuckDB 版本兼容 | 1.1.x |
| NFR-004 | 编译器支持 | Clang 15+ |

### 4.2 可靠性需求

| 需求ID | 描述 | 目标 |
|--------|------|------|
| NFR-100 | 计算结果正确性 | 100% 与 DuckDB 一致 |
| NFR-101 | 崩溃率 | 0% |
| NFR-102 | 内存泄漏 | 0 |

### 4.3 可维护性需求

| 需求ID | 描述 | 目标 |
|--------|------|------|
| NFR-200 | 代码覆盖率 | ≥80% |
| NFR-201 | 文档完整性 | 所有公开 API 有文档 |
| NFR-202 | 代码风格一致性 | clang-format 规范 |

---

## 五、约束条件

### 5.1 技术约束

| 约束 | 说明 |
|------|------|
| **目标平台** | 仅支持 Apple Silicon (ARM64) |
| **SIMD** | 仅使用 ARM Neon (不使用 SVE/SVE2) |
| **编程语言** | C/C++17，必要时使用汇编 |
| **依赖** | 最小化外部依赖 |

### 5.2 资源约束

| 约束 | 说明 |
|------|------|
| **内存** | 不额外分配超过输入数据 20% 的内存 |
| **线程** | 单线程实现为主，多线程为可选 |

---

## 六、验收标准

### 6.1 v2.0 验收 (已完成)

| 标准 | 结果 |
|------|------|
| ✅ 总体胜率 ≥60% | 71% |
| ✅ Aggregation 100% 胜率 | 达成 |
| ✅ Sort 100% 胜率 | 达成 |
| ✅ 所有测试用例通过 | 达成 |
| ✅ 无内存泄漏 | 达成 |

### 6.2 v3.0 验收标准

| 标准 | 目标 |
|------|------|
| Filter 胜率 100% | 4/4 测试超越 DuckDB |
| TopK 胜率 100% | 3/3 测试超越 DuckDB |
| 总体胜率 ≥86% | ≥12/14 测试胜出 |
| 无性能回归 | 已有优势项保持 |
| 文档完整 | 所有变更有文档 |

---

## 七、优先级定义

| 优先级 | 定义 |
|--------|------|
| **P0** | 必须实现，阻塞发布 |
| **P1** | 应该实现，高价值 |
| **P2** | 可以实现，锦上添花 |
| **P3** | 未来考虑 |

---

## 八、需求追踪

### 8.1 版本需求映射

| 版本 | 主要需求 |
|------|----------|
| v1.0 | FR-001.1-6, FR-002.1-4, FR-003.1-3, FR-004.1-3, FR-005.1 |
| v2.0 | FR-002.5, FR-003.4-5, FR-005.2, PR-001-005 |
| v3.0 | FR-004.5, PR-101-103 |

### 8.2 需求变更记录

| 日期 | 变更 | 原因 |
|------|------|------|
| 2026-01-24 | 新增 PR-101-103 | v3.0 Filter 优化目标 |
| 2026-01-24 | 新增 FR-004.5 | TopK K值自适应需求 |

---

*ThunderDuck 需求文档 v3.0*
