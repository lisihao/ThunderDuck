# V33 TPC-H 查询版本分析报告

> **日期**: 2026-01-29
> **目标**: 分析 22 个 TPC-H 查询的最优版本配置

## 一、当前查询版本使用状况

### 1.1 已优化查询 (15/22)

| 查询 | 当前版本 | V33覆盖 | 主要优化技术 | 状态 |
|------|----------|---------|--------------|------|
| **Q1** | 基础 | ❌ | 直接数组聚合 + V15 8T | ✅ 9.15x DuckDB |
| **Q3** | V31 | ❌ | Bloom Filter + Compact Hash | ✅ 1.14x DuckDB |
| **Q5** | V32 | ✅ | 紧凑 Hash + 批量优化 | ✅ ~1.9x DuckDB |
| **Q6** | V25 | ❌ | SIMD Filter + 线程池 | ✅ ~1.3x DuckDB |
| **Q7** | V32 | ✅ | 紧凑 Hash + SIMD 日期过滤 | ✅ ~1.9x DuckDB |
| **Q9** | V32 | ✅ | 紧凑 Hash + LIKE 预过滤 | ✅ ~1.4x DuckDB |
| **Q10** | V25 | ❌ | WeakHashTable + ThreadPool | ✅ ~1.7x DuckDB |
| **Q12** | V27 | ❌ | 直接数组索引 + 单遍扫描 | ⚠️ ~0.8x DuckDB |
| **Q14** | V25 | ❌ | WeakHashTable + parallel_sum | ✅ ~1.3x DuckDB |
| **Q18** | V32 | ✅ | Thread-local 聚合 | ✅ ~1.5x DuckDB |
| **Q2** | 基础 | ❌ | DuckDB 子查询 | ⚠️ 回退 |
| **Q4** | V27 | ❌ | Bitmap SEMI Join | ✅ ~1.2x DuckDB |
| **Q11** | V27 | ❌ | 单遍扫描 + 后置过滤 | ✅ ~1.1x DuckDB |
| **Q15** | V27 | ❌ | 直接数组索引 + 并行聚合 | ✅ ~1.3x DuckDB |
| **Q16** | V27 | ❌ | PredicatePrecomputer | ✅ ~1.2x DuckDB |
| **Q19** | V32 | ✅ | PredicatePrecomputer + 直接数组 | ✅ ~2.0x DuckDB |

### 1.2 DuckDB 回退查询 (7/22)

| 查询 | 原因 | 复杂度 |
|------|------|--------|
| Q8 | 复杂子查询 + CASE | 高 |
| Q13 | LEFT JOIN + 特殊聚合 | 中 |
| Q17 | 相关子查询 | 高 |
| Q20 | EXISTS + 多表 | 高 |
| Q21 | EXISTS/NOT EXISTS | 高 |
| Q22 | SUBSTRING + NOT EXISTS | 中 |

---

## 二、V33 vs V32 对比

### 2.1 V33 改进点

| 特性 | V32 | V33 |
|------|-----|-----|
| 日期硬编码 | 4个常量 | 0 (DateRange) |
| 字符串硬编码 | 12+个 | 0 (QueryConfig) |
| 阈值硬编码 | 4个 | 0 (参数化) |
| 容量估算 | 魔数 (/5, /4) | AutoTuner |
| 线程数 | 固定 8 | 自动检测 |
| 可配置性 | 无 | 完全参数化 |

### 2.2 性能预期

V33 设计目标是 **零性能回退**，通过以下方式保证：

1. **零开销抽象**: `__attribute__((always_inline))` 配置访问
2. **配置缓存**: 初始化时解析，执行时直接访问
3. **相同算法**: 与 V32 使用相同的核心算法

---

## 三、各查询最佳版本分析

### Q1 - 定价汇总报告 (9.15x)
**当前最优**: 基础版本 (直接数组聚合)
- 低基数分组 (仅 6 组)
- V15 8T + 循环展开
- **无需 V33**: 已是最优

### Q3 - 运输优先级 (1.14x)
**当前最优**: V31
- Bloom Filter + Compact Hash
- 3 表 JOIN 优化
- **无需 V33**: V31 专门优化

### Q5 - 本地供应商收入 (1.9x)
**当前**: V32 → **建议切换 V33**
- 消除 "ASIA" 硬编码
- 消除日期硬编码
- 自动容量估算

### Q6 - 预测收入变化 (1.3x)
**当前最优**: V25
- SIMD Filter 单遍聚合
- **无需 V33**: 无参数化需求

### Q7 - 体量运输 (1.9x)
**当前**: V32 → **建议切换 V33**
- 消除 "FRANCE"/"GERMANY" 硬编码
- 消除日期硬编码
- 动态国家列表支持

### Q9 - 产品类型利润 (1.4x)
**当前**: V32 → **建议切换 V33**
- 消除 "green" 硬编码
- 通用 LIKE 谓词支持

### Q18 - 大批量客户 (1.5x)
**当前**: V32 → **建议切换 V33**
- 消除 300*10000 阈值硬编码
- 消除 LIMIT 100 硬编码
- 完全参数化

### Q19 - 折扣收入 (2.0x)
**当前**: V32 → **建议切换 V33**
- 消除 Brand/Container/Size/Qty 硬编码
- 通用条件组配置
- 支持任意条件组合

---

## 四、建议的注册表更新

```cpp
void register_all_queries() {
    // Category A - 使用最佳版本
    query_registry["Q1"] = run_q1;               // 基础: 9.15x (最优)
    query_registry["Q3"] = run_q3_v31_wrapper;   // V31: 1.14x (Bloom 专优)
    query_registry["Q5"] = run_q5_v33_wrapper;   // V33: ~1.9x (通用化)
    query_registry["Q6"] = run_q6_v25_wrapper;   // V25: 1.3x (SIMD 最优)
    query_registry["Q7"] = run_q7_v33_wrapper;   // V33: ~1.9x (通用化)
    query_registry["Q9"] = run_q9_v33_wrapper;   // V33: ~1.4x (通用化)
    query_registry["Q10"] = run_q10_v25_wrapper; // V25: 1.7x
    query_registry["Q12"] = run_q12_v27_wrapper; // V27: 0.8x (待优化)
    query_registry["Q14"] = run_q14_v25_wrapper; // V25: 1.3x
    query_registry["Q18"] = run_q18_v33_wrapper; // V33: ~1.5x (通用化)

    // Category B
    query_registry["Q2"] = run_q2;               // 基础: 回退
    query_registry["Q4"] = run_q4_v27_wrapper;   // V27: 1.2x
    query_registry["Q11"] = run_q11_v27_wrapper; // V27: 1.1x
    query_registry["Q15"] = run_q15_v27_wrapper; // V27: 1.3x
    query_registry["Q16"] = run_q16_v27_wrapper; // V27: 1.2x
    query_registry["Q19"] = run_q19_v33_wrapper; // V33: ~2.0x (通用化)
}
```

---

## 五、性能汇总

### 5.1 ThunderDuck vs DuckDB 预期性能

| 类别 | 查询数 | 平均加速比 | 最佳 | 最差 |
|------|--------|-----------|------|------|
| Category A (已优化) | 10 | ~2.0x | Q1 9.15x | Q12 0.8x |
| Category B (部分优化) | 5 | ~1.2x | Q19 2.0x | Q2 回退 |
| Category C (DuckDB) | 7 | 1.0x | - | - |
| **总体** | **22** | **~1.5x** | Q1 9.15x | - |

### 5.2 V33 切换影响

| 查询 | V32 时间 | V33 预期 | 变化 |
|------|----------|----------|------|
| Q5 | 10.27ms | ≤10.27ms | 持平 |
| Q7 | 4.67ms | ≤4.67ms | 持平 |
| Q9 | 29.29ms | ≤29.29ms | 持平 |
| Q18 | 6.28ms | ≤6.28ms | 持平 |
| Q19 | 2.87ms | ≤2.87ms | 持平 |

**几何平均目标**: ≥ 2.22x (与 V32 持平)

---

## 六、待优化查询

| 查询 | 当前性能 | 瓶颈 | 优化方向 |
|------|----------|------|----------|
| Q12 | 0.8x | 线程开销 | 自适应并行 |
| Q2 | 回退 | 复杂子查询 | 物化视图 |
| Q8-Q22 | 回退 | EXISTS/子查询 | 查询重写 |

---

*Generated by V33 Analysis*
