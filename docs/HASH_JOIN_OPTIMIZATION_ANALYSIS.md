# Hash Join 优化分析报告

> **日期**: 2026-01-27 | **版本**: V10.1/V10.2 实验总结

## 一、问题背景

在 Hash Join 的 build 到 probe 过程中，可能存在以下开销：
1. 内存拷贝 (数据复制到分区)
2. 重复哈希计算 (histogram + scatter 各一次)
3. 索引转换 (分区索引 → 原始索引)
4. 结果合并 (多分区结果 memcpy 到最终缓冲区)

## 二、优化尝试

### V10.1 - 零拷贝方案

**思路**: 不拷贝键数据，只存储指针/索引

```cpp
// V10.1: 通过索引间接访问
if (keys_ptr_[build_idx] == probe_key)  // 随机内存访问!
```

**结果**: **比 V3 慢 35%** (5.651ms vs 4.172ms)

**原因分析**:
- 间接访问导致随机内存访问模式
- 缓存局部性完全丧失
- 每次键比较都是 cache miss

### V10.2 - 单次哈希方案

**思路**: 哈希只计算一次，缓存起来复用

```cpp
// V10.2: 缓存哈希值
std::vector<uint32_t> hash_cache(count);
for (i...) hash_cache[i] = hash_key(keys[i]);
// 后续复用 hash_cache
```

**结果**: **比 V3 慢 19%** (4.948ms vs 4.172ms)

**原因分析**:
- CRC32 在 ARM 上是单周期指令，重复计算开销很小
- 额外的哈希缓存增加 50% 内存占用
- 更多内存 = 更多 cache miss

## 三、关键发现

### 1. 数据拷贝是值得的

**反直觉结论**: 拷贝数据到分区 **改善** 了性能，而不是伤害。

原因:
- 拷贝后，分区内的键是连续存储的
- Hash Join 的探测阶段访问模式变成顺序访问
- 缓存预取可以有效工作

```
原始数据: [k0, k1, k2, k3, ...] (可能分散在内存中)
分区后:   [k2, k5, k8, ...]     (连续存储，cache 友好)
```

### 2. CRC32 硬件加速非常快

在 Apple M4 上，CRC32 是单周期指令：
- 100K 键 × 2 次计算 = 200K 次 CRC32
- 200K cycles @ 4GHz = 0.05ms
- 远小于内存访问开销

**结论**: 省哈希计算不如省内存访问。

### 3. 内存带宽是瓶颈

100K build + 1M probe @ 10% 匹配率:
- 数据量: ~4.4MB
- DuckDB: 3.5ms → 带宽 ~1.2 GB/s
- 理论 L3 带宽: ~200 GB/s
- **瓶颈不在带宽，在 cache miss**

## 四、性能对比

| 版本 | 时间(ms) | vs DuckDB | 特点 |
|------|----------|-----------|------|
| DuckDB | 3.47 | 1.00x | 基准 |
| V7 | 3.68 | **0.94x** | 自适应策略 |
| V6 | 3.80 | **0.91x** | 简化预取 |
| V10 | 4.06 | 0.85x | 委托 V3 |
| V3 | 4.17 | 0.83x | 分区 + 并行 |
| V10.2 | 4.95 | 0.70x | 单次哈希 |
| V10.1 | 5.65 | 0.61x | 零拷贝 |

## 五、推荐方案

### 推荐: V6 或 V7

- **V6**: 简化预取，代码简洁
- **V7**: 自适应策略，自动选择最优实现

### 不推荐的优化方向

1. **零拷贝**: 间接访问开销 > 拷贝开销
2. **哈希缓存**: 内存开销 > 计算开销
3. **过度预取**: 预取计算本身也有开销

## 六、进一步优化方向

如果要进一步超越 DuckDB，可以考虑:

1. **SIMD 哈希表探测**: 一次比较 4-8 个槽位
2. **更好的分区策略**: 根据 L1/L2 缓存大小动态调整
3. **结果物化优化**: 直接生成最终所需格式
4. **向量化执行**: 批量处理而非逐行处理

## 七、结论

1. **零拷贝不是万能的** - 缓存局部性比拷贝开销更重要
2. **CRC32 够快** - 不需要缓存哈希值
3. **V6/V7 已接近最优** - 达到 DuckDB 94% 性能
4. **进一步优化需要更深层次的改变** - 如 SIMD 哈希表或向量化执行
