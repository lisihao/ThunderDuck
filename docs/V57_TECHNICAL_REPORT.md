# ThunderDuck V57 Technical Report

> **Version**: V57 | **Date**: 2026-01-30 | **Platform**: Apple M4 Max | **Format**: TVS 1.0

```
+==============================================================================+
|                                                                              |
|   ████████╗██╗  ██╗██╗   ██╗███╗   ██╗██████╗ ███████╗██████╗                |
|   ╚══██╔══╝██║  ██║██║   ██║████╗  ██║██╔══██╗██╔════╝██╔══██╗               |
|      ██║   ███████║██║   ██║██╔██╗ ██║██║  ██║█████╗  ██████╔╝               |
|      ██║   ██╔══██║██║   ██║██║╚██╗██║██║  ██║██╔══╝  ██╔══██╗               |
|      ██║   ██║  ██║╚██████╔╝██║ ╚████║██████╔╝███████╗██║  ██║               |
|      ╚═╝   ╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝╚═════╝ ╚══════╝╚═╝  ╚═╝               |
|                                                                              |
|              D U C K         Zero-Overhead Generic Operators                 |
|                                                                              |
|   Geometric Mean Speedup: 2.88x  |  Win Rate: 95.5% (21/22 queries)         |
|                                                                              |
+==============================================================================+
```

---

## Executive Summary

```
+------------------------------------------------------------------------------+
|  PROJECT METRICS                                                             |
+------------------------------------------------------------------------------+
|                                                                              |
|   Target Platform    Apple M4 Max (16C CPU / 40C GPU / 16C ANE)              |
|   Baseline System    DuckDB v1.1.3                                           |
|   Benchmark Suite    TPC-H SF=1 (22 Queries, ~8.6M rows)                     |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  KEY ACHIEVEMENTS                                                     |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |    Geometric Mean Speedup    [===================>      ]  2.88x     |  |
|   |    Queries Faster            [=======================>  ]  21/22     |  |
|   |    Queries Equal             [=>                        ]   1/22     |  |
|   |    Queries Slower            [                          ]   0/22     |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   Best:  Q21 (21.77x)  Q22 (8.84x)  Q1 (6.13x)  Q19 (6.32x)                 |
|                                                                              |
+------------------------------------------------------------------------------+
```

---

## 1. Background and Vision

### 1.1 Project Motivation

```
+------------------------------------------------------------------------------+
|  WHY THUNDERDUCK?                                                            |
+------------------------------------------------------------------------------+
|                                                                              |
|   Problem Statement:                                                         |
|   +-----------------------------------------------------------------------+  |
|   |  DuckDB is highly optimized, but does not fully exploit Apple M4     |  |
|   |  hardware capabilities:                                               |  |
|   |                                                                       |  |
|   |    - ARM Neon SIMD (128-bit vectors)                                 |  |
|   |    - 16MB L2 Cache per performance cluster                           |  |
|   |    - 128-byte cache lines                                            |  |
|   |    - Apple Metal GPU / ANE Neural Engine                             |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   Solution:                                                                  |
|   +-----------------------------------------------------------------------+  |
|   |  Build a custom operator backend optimized for Apple Silicon M4:     |  |
|   |                                                                       |  |
|   |    [Hardware-Aware]  L2-cache-friendly data layouts                  |  |
|   |    [Zero-Overhead]   Template metaprogramming, no virtual calls      |  |
|   |    [Adaptive]        Auto-select direct array vs hash table          |  |
|   |    [Parallel]        Thread-local aggregation, lock-free merge       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 1.2 Success Criteria

| Criterion | Target | Achieved |
|-----------|--------|----------|
| Geometric Mean Speedup | > 2.0x | **2.88x** |
| Win Rate (vs DuckDB) | > 80% | **95.5%** |
| No Query Slower | 0 queries | **0 queries** |
| Code Maintainability | Generic operators | **V57 Framework** |

---

## 2. Architecture Design

### 2.1 Multi-Version Operator Evolution

```
+------------------------------------------------------------------------------+
|  VERSION EVOLUTION: V24 --> V57                                              |
+------------------------------------------------------------------------------+
|                                                                              |
|   Phase 1: Foundation (V24-V27)                                              |
|   +---------+---------+---------+---------+                                  |
|   |  V24    |  V25    |  V26    |  V27    |                                  |
|   | Select  | Thread  | Optim   | Bitmap  |                                  |
|   | Vector  | Pool    | Direct  | SEMI    |                                  |
|   +---------+---------+---------+---------+                                  |
|        |         |         |         |                                       |
|        v         v         v         v                                       |
|   Phase 2: Optimization (V32-V37)                                            |
|   +---------+---------+---------+---------+---------+---------+              |
|   |  V32    |  V33    |  V34    |  V35    |  V36    |  V37    |              |
|   | Compact | Config  | Deep    | Generic | Decorr  | Bitmap  |              |
|   | Hash    | Driven  | Optim   | Arch    | Subqry  | ANTI    |              |
|   +---------+---------+---------+---------+---------+---------+              |
|        |         |         |         |         |         |                   |
|        v         v         v         v         v         v                   |
|   Phase 3: Specialized (V40-V48) [DEPRECATED]                                |
|   +---------+---------+---------+---------+---------+---------+---------+    |
|   |  V40    |  V42    |  V43    |  V44    |  V45    |  V46    |  V48    |    |
|   |  Q20    |  Q8     |  Q17    |  Q3     |  Q21    |  Q14    |  Q12    |    |
|   | Specif. | Specif. | Specif. | Specif. | Specif. | Specif. | Specif. |    |
|   +---------+---------+---------+---------+---------+---------+---------+    |
|        |                                                                     |
|        +--------------------> DELETED (replaced by V57)                      |
|                                                                              |
|   Phase 4: Universal (V57)                                                   |
|   +-----------------------------------------------------------------------+  |
|   |                          V57 GENERIC FRAMEWORK                        |  |
|   |                                                                       |  |
|   |   [AdaptiveMap] [DirectArray] [ZeroCostAggregator] [ParallelScanner] |  |
|   |                                                                       |  |
|   |   Replaces: V42-Q8, V43-Q17, V44-Q3, V55-Q12, V56-Q5                  |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 2.2 System Catalog Architecture

```
+------------------------------------------------------------------------------+
|  SYSTEM CATALOG (Configuration-Driven Design)                                |
+------------------------------------------------------------------------------+
|                                                                              |
|   +-------------------------+     +-------------------------+                |
|   |   Query Registry        |     |   Operator Registry     |                |
|   +-------------------------+     +-------------------------+                |
|   |                         |     |                         |                |
|   |  Q1  --> [V57, Base]    |     |  AdaptiveMap       V57  |                |
|   |  Q2  --> [Base]         |     |  DirectArray       V57  |                |
|   |  Q3  --> [V57, V31]     |     |  ZeroCostAggregator V57 |                |
|   |  Q4  --> [V27]          |     |  ParallelScanner   V57  |                |
|   |  Q5  --> [V57, V32]     | --> |  SIMDFilter        V19  |                |
|   |  Q6  --> [V25]          |     |  CompactHashTable  V32  |                |
|   |  ...                    |     |  BloomFilter       V27  |                |
|   |  Q22 --> [V37]          |     |  ThreadLocalAgg    V32  |                |
|   |                         |     |                         |                |
|   +-------------------------+     +-------------------------+                |
|              |                                |                              |
|              v                                v                              |
|   +---------------------------------------------------------------+          |
|   |              QUERY OPTIMIZER + EXECUTOR                       |          |
|   +---------------------------------------------------------------+          |
|   |                                                               |          |
|   |   Input: SQL Query                                            |          |
|   |   Output: Optimized Execution Plan                            |          |
|   |                                                               |          |
|   |   [Parse] --> [Select Operators] --> [Execute] --> [Result]   |          |
|   |                                                               |          |
|   +---------------------------------------------------------------+          |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 2.3 Zero Hard-Coding Principle

```
+------------------------------------------------------------------------------+
|  IRON LAW: ZERO HARD-CODING                                                  |
+------------------------------------------------------------------------------+
|                                                                              |
|   PROHIBITED:                                                                |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |   // WRONG: Magic numbers                                            |  |
|   |   if (key_range < 65536) use_direct_array();  // Why 65536?          |  |
|   |                                                                       |  |
|   |   // WRONG: Query-specific code                                      |  |
|   |   if (query == "Q5") { /* special handling */ }                      |  |
|   |                                                                       |  |
|   |   // WRONG: Platform assumptions                                     |  |
|   |   constexpr size_t L2_CACHE = 4 * 1024 * 1024;  // Not all M4       |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   REQUIRED:                                                                  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |   // CORRECT: Hardware-derived thresholds                            |  |
|   |   size_t max_direct = hw::l2_friendly_count<Entry>();                |  |
|   |                                                                       |  |
|   |   // CORRECT: Generic operators                                      |  |
|   |   AdaptiveMap<ValueT> map;  // Works for any query                   |  |
|   |                                                                       |  |
|   |   // CORRECT: Runtime hardware detection                             |  |
|   |   size_t l2_size = sysctlbyname("hw.l2cachesize", ...);              |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

---

## 3. V57 Generic Operator Framework (Core Innovation)

### 3.1 Design Principles

```
+------------------------------------------------------------------------------+
|  V57 DESIGN PRINCIPLES                                                       |
+------------------------------------------------------------------------------+
|                                                                              |
|   +-----------------------------------+                                      |
|   |  1. ZERO HARD-CODING              |                                      |
|   +-----------------------------------+                                      |
|   |                                   |                                      |
|   |  All thresholds derived from      |                                      |
|   |  hardware at runtime:             |                                      |
|   |                                   |                                      |
|   |  L2 Cache Size --> Max Direct     |                                      |
|   |  CPU Cores --> Thread Count       |                                      |
|   |  Cache Line --> Alignment         |                                      |
|   |                                   |                                      |
|   +-----------------------------------+                                      |
|                                                                              |
|   +-----------------------------------+                                      |
|   |  2. ZERO SPECIALIZED DESIGN       |                                      |
|   +-----------------------------------+                                      |
|   |                                   |                                      |
|   |  All operators query-agnostic:    |                                      |
|   |                                   |                                      |
|   |  AdaptiveMap<T>      // Any T     |                                      |
|   |  DirectArray<T>      // Any T     |                                      |
|   |  ZeroCostAggregator  // Any Agg   |                                      |
|   |  ParallelScanner     // Any Scan  |                                      |
|   |                                   |                                      |
|   +-----------------------------------+                                      |
|                                                                              |
|   +-----------------------------------+                                      |
|   |  3. ZERO RUNTIME OVERHEAD         |                                      |
|   +-----------------------------------+                                      |
|   |                                   |                                      |
|   |  Template parameters eliminate    |                                      |
|   |  runtime decisions:               |                                      |
|   |                                   |                                      |
|   |  if constexpr (...)  // Compile   |                                      |
|   |  Template<Op>::apply // Inline    |                                      |
|   |  __attribute__((always_inline))   |                                      |
|   |                                   |                                      |
|   +-----------------------------------+                                      |
|                                                                              |
|   +-----------------------------------+                                      |
|   |  4. ADAPTIVE STORAGE              |                                      |
|   +-----------------------------------+                                      |
|   |                                   |                                      |
|   |  Auto-select based on key range:  |                                      |
|   |                                   |                                      |
|   |  Key Range < L2/sizeof(Entry)     |                                      |
|   |    --> DirectArray (O(1) access)  |                                      |
|   |                                   |                                      |
|   |  Key Range >= L2/sizeof(Entry)    |                                      |
|   |    --> CompactHashTable           |                                      |
|   |                                   |                                      |
|   +-----------------------------------+                                      |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 3.2 Core Operators

#### AdaptiveMap

```
+------------------------------------------------------------------------------+
|  AdaptiveMap<ValueT>                                                         |
+------------------------------------------------------------------------------+
|                                                                              |
|  Purpose: Self-tuning key-value storage                                      |
|                                                                              |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   build(keys, values, count, filter)                                  |   |
|  |       |                                                               |   |
|  |       v                                                               |   |
|  |   +-------------------+                                               |   |
|  |   | Analyze Key Range |                                               |   |
|  |   +-------------------+                                               |   |
|  |       |                                                               |   |
|  |       +--------------------+--------------------+                     |   |
|  |       |                    |                    |                     |   |
|  |       v                    v                    v                     |   |
|  |   range <= L2/size    range > L2/size     high sparsity              |   |
|  |       |                    |                    |                     |   |
|  |       v                    v                    v                     |   |
|  |   DirectArray         CompactHash          Fallback Hash             |   |
|  |   O(1) access         O(1) amortized       O(1) amortized            |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  API:                                                                        |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   const ValueT* find(int32_t key);        // Single lookup           |   |
|  |   bool contains(int32_t key);             // Existence check         |   |
|  |   void batch_find(keys, results, n=8);    // 8-way prefetch         |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

#### DirectArray

```
+------------------------------------------------------------------------------+
|  DirectArray<ValueT>                                                         |
+------------------------------------------------------------------------------+
|                                                                              |
|  Purpose: Zero-overhead direct indexing when key range is small              |
|                                                                              |
|  Memory Layout:                                                              |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   data_:  [V0][V1][V2][V3][V4][V5][V6]...                            |   |
|  |   valid_: [ 1][ 0][ 1][ 1][ 0][ 1][ 0]...  (uint8_t, not bool)       |   |
|  |                                                                       |   |
|  |   Access: data_[key]  --> O(1), no hash computation                  |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Use Cases:                                                                  |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   - nation_key (0-24)      --> 25 entries                            |   |
|  |   - shipmode_key (0-6)     --> 7 entries                             |   |
|  |   - returnflag_key (0-2)   --> 3 entries                             |   |
|  |   - supplier_key (0-10000) --> 10K entries (fits L2)                 |   |
|  |   - customer_key (0-150K)  --> 150K entries (fits L2)                |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

#### ZeroCostAggregator

```
+------------------------------------------------------------------------------+
|  ZeroCostAggregator<ValueT, AggOp>                                           |
+------------------------------------------------------------------------------+
|                                                                              |
|  Purpose: Template-parameterized aggregation (no virtual calls)              |
|                                                                              |
|  Aggregation Operations:                                                     |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   struct SumOp {                                                     |   |
|  |       static void apply(T& acc, T val) { acc += val; }               |   |
|  |   };                                                                  |   |
|  |                                                                       |   |
|  |   struct MinOp {                                                     |   |
|  |       static void apply(T& acc, T val) { if (val < acc) acc = val; } |   |
|  |   };                                                                  |   |
|  |                                                                       |   |
|  |   struct MaxOp {                                                     |   |
|  |       static void apply(T& acc, T val) { if (val > acc) acc = val; } |   |
|  |   };                                                                  |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Inlining:                                                                   |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   ZeroCostAggregator<int64_t, SumOp> agg;                            |   |
|  |   agg.aggregate(key, value);                                          |   |
|  |                                                                       |   |
|  |   Compiles to:                                                        |   |
|  |       states_[key].value += value;  // Direct, no call overhead       |   |
|  |       states_[key].count++;                                           |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

#### ZeroCostTwoPhaseAgg

```
+------------------------------------------------------------------------------+
|  ZeroCostTwoPhaseAgg (Q17 Optimization Core)                                 |
+------------------------------------------------------------------------------+
|                                                                              |
|  Purpose: Two-phase aggregation for correlated subqueries                    |
|                                                                              |
|  Phase 1: Compute AVG per key                                                |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   Thread 0: [sum0][count0]  Thread 1: [sum1][count1]  ...            |   |
|  |                  \              /                                     |   |
|  |                   \            /                                      |   |
|  |                    v          v                                       |   |
|  |             merge() --> global_sum[], global_count[]                  |   |
|  |                              |                                        |   |
|  |                              v                                        |   |
|  |             threshold[k] = 0.2 * sum[k] / count[k]                    |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Phase 2: Filter and accumulate                                              |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   for each row:                                                       |   |
|  |       if (quantity < threshold[partkey]):                            |   |
|  |           result += extendedprice                                     |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Memory Layout (Separated for Cache Efficiency):                             |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   global_sum_:   [S0][S1][S2][S3][S4]...  // int64_t[]               |   |
|  |   global_count_: [C0][C1][C2][C3][C4]...  // int32_t[]               |   |
|  |                                                                       |   |
|  |   NOT: struct { int64_t sum; int32_t count; }[]  // Wastes padding   |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

#### ParallelScanner

```
+------------------------------------------------------------------------------+
|  ParallelScanner                                                             |
+------------------------------------------------------------------------------+
|                                                                              |
|  Purpose: Generic parallel iteration with automatic partitioning             |
|                                                                              |
|  API:                                                                        |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   ParallelScanner::scan(count, [&](thread_id, start, end) {          |   |
|  |       for (size_t i = start; i < end; ++i) {                         |   |
|  |           // Process row i using thread_id for local storage          |   |
|  |       }                                                               |   |
|  |   });                                                                 |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Work Distribution (M4 Max: 8 threads):                                      |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   Total: 6,000,000 rows                                              |   |
|  |                                                                       |   |
|  |   Thread 0: [      0 -  749,999]  750K rows                          |   |
|  |   Thread 1: [750,000 - 1,499,999] 750K rows                          |   |
|  |   Thread 2: [1.5M    - 2,249,999] 750K rows                          |   |
|  |   ...                                                                 |   |
|  |   Thread 7: [5.25M   - 5,999,999] 750K rows                          |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

---

## 4. Performance Optimization Techniques

### 4.1 ARM Neon SIMD Vectorization

```
+------------------------------------------------------------------------------+
|  SIMD VECTORIZATION                                                          |
+------------------------------------------------------------------------------+
|                                                                              |
|  Vector Types:                                                               |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   int32x4_t   --> 4 x int32  (128 bits)                              |   |
|  |   float32x4_t --> 4 x float  (128 bits)                              |   |
|  |   uint8x16_t  --> 16 x uint8 (128 bits)                              |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Example: Filter (l_quantity < 24)                                           |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   Scalar:                        SIMD:                                |   |
|  |   for (i = 0; i < n; i++)        for (i = 0; i < n; i += 4)          |   |
|  |     if (qty[i] < 24)               v = vld1q_s32(&qty[i]);           |   |
|  |       result[j++] = i;             mask = vcltq_s32(v, thresh);       |   |
|  |                                    // Process 4 elements at once      |   |
|  |                                                                       |   |
|  |   Throughput: 1 elem/cycle       Throughput: 4 elems/cycle           |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 4.2 L2 Cache-Aware Data Layout

```
+------------------------------------------------------------------------------+
|  CACHE-AWARE DESIGN                                                          |
+------------------------------------------------------------------------------+
|                                                                              |
|  Apple M4 Cache Hierarchy:                                                   |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   L1D Cache:  128 KB / core  (4 cycles)                              |   |
|  |   L2 Cache:   4-16 MB / cluster (12 cycles)                          |   |
|  |   Memory:     128 GB DDR5 (100+ cycles)                              |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Direct Array Threshold Calculation:                                         |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   L2 Size = sysctlbyname("hw.l2cachesize")  // e.g., 4 MB            |   |
|  |                                                                       |   |
|  |   Max Direct Elements = L2 * 0.5 / sizeof(Entry)                     |   |
|  |                       = 4 MB * 0.5 / 16 bytes                        |   |
|  |                       = 131,072 elements                              |   |
|  |                                                                       |   |
|  |   If key_range <= 131K --> Use DirectArray                           |   |
|  |   If key_range >  131K --> Use CompactHashTable                      |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 4.3 Thread-Local Aggregation

```
+------------------------------------------------------------------------------+
|  THREAD-LOCAL AGGREGATION + MERGE                                            |
+------------------------------------------------------------------------------+
|                                                                              |
|  Pattern:                                                                    |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   Phase 1: Parallel Local Aggregation (No Locks)                     |   |
|  |                                                                       |   |
|  |   Thread 0        Thread 1        Thread 2        Thread 7           |   |
|  |   +--------+      +--------+      +--------+      +--------+         |   |
|  |   |Local[0]|      |Local[1]|      |Local[2]| ...  |Local[7]|         |   |
|  |   +--------+      +--------+      +--------+      +--------+         |   |
|  |       |               |               |               |              |   |
|  |       v               v               v               v              |   |
|  |   +---------------------------------------------------+              |   |
|  |   |              Phase 2: Sequential Merge            |              |   |
|  |   +---------------------------------------------------+              |   |
|  |                           |                                          |   |
|  |                           v                                          |   |
|  |                    +-----------+                                     |   |
|  |                    | Global[k] |                                     |   |
|  |                    +-----------+                                     |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Benefits:                                                                   |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   - No lock contention during hot path                               |   |
|  |   - No false sharing (separate cache lines)                          |   |
|  |   - Linear scalability with thread count                             |   |
|  |   - Merge is O(keys * threads), typically negligible                 |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 4.4 Compile-Time Branch Elimination

```
+------------------------------------------------------------------------------+
|  COMPILE-TIME OPTIMIZATION                                                   |
+------------------------------------------------------------------------------+
|                                                                              |
|  Using constexpr if:                                                         |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   template<typename FilterFn>                                        |   |
|  |   void build(const int32_t* keys, ..., FilterFn filter) {            |   |
|  |                                                                       |   |
|  |       for (size_t i = 0; i < count; ++i) {                           |   |
|  |           if constexpr (!std::is_same_v<FilterFn, std::nullptr_t>) { |   |
|  |               if (!filter(i)) continue;  // Compiled only if needed  |   |
|  |           }                                                           |   |
|  |           // ... rest of build                                        |   |
|  |       }                                                               |   |
|  |   }                                                                   |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
|  Result:                                                                     |
|  +-----------------------------------------------------------------------+   |
|  |                                                                       |   |
|  |   build(keys, values, count, nullptr)  // No filter check in loop    |   |
|  |   build(keys, values, count, myFilter) // Filter check included      |   |
|  |                                                                       |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

---

## 5. TPC-H Performance Baseline (SF=1)

### 5.1 Complete 22-Query Results

```
+==============================================================================+
|  TPC-H SF=1 BENCHMARK RESULTS                                                |
+==============================================================================+
|                                                                              |
|  Test Configuration:                                                         |
|  +-----------------------------------------------------------------------+   |
|  |  Platform:     Apple M4 Max (16C CPU, 40C GPU, 16C ANE)              |   |
|  |  Memory:       128 GB                                                 |   |
|  |  Iterations:   30 (IQR outlier removal, median reported)             |   |
|  |  Scale Factor: 1 (~8.6M rows, ~397 MB)                               |   |
|  +-----------------------------------------------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
|                                                                              |
|  Query Performance:                                                          |
|                                                                              |
|  +------+----------+----------+---------+-------------------------------+   |
|  | Q#   | DuckDB   | Thunder  | Speedup | Bar Chart                     |   |
|  |      | (ms)     | (ms)     |         |                               |   |
|  +------+----------+----------+---------+-------------------------------+   |
|  | Q1   |   31.62  |    5.16  |  6.13x  | [============>        ] HIGH  |   |
|  | Q2   |    7.77  |    5.28  |  1.47x  | [====>                ]       |   |
|  | Q3   |   13.43  |   10.25  |  1.31x  | [===>                 ]       |   |
|  | Q4   |   15.05  |    4.25  |  3.54x  | [========>            ]       |   |
|  | Q5   |   12.28  |    7.77  |  1.58x  | [====>                ] V57   |   |
|  | Q6   |    2.88  |    1.48  |  1.94x  | [=====>               ]       |   |
|  | Q7   |   12.43  |    4.41  |  2.82x  | [=======>             ]       |   |
|  | Q8   |   12.65  |    8.43  |  1.50x  | [====>                ] V57   |   |
|  | Q9   |   47.08  |   33.18  |  1.42x  | [===>                 ]       |   |
|  | Q10  |   31.69  |   12.33  |  2.57x  | [======>              ]       |   |
|  | Q11  |    4.23  |    1.67  |  2.54x  | [======>              ]       |   |
|  | Q12  |   20.79  |   20.75  |  1.00x  | [==                   ] EQUAL |   |
|  | Q13  |   33.45  |   12.96  |  2.58x  | [======>              ]       |   |
|  | Q14  |    9.12  |    1.86  |  4.90x  | [===========>         ]       |   |
|  | Q15  |    6.08  |    1.73  |  3.51x  | [========>            ]       |   |
|  | Q16  |   12.91  |    6.90  |  1.87x  | [=====>               ]       |   |
|  | Q17  |   13.42  |    4.81  |  2.79x  | [=======>             ] V57   |   |
|  | Q18  |   33.60  |    8.38  |  4.01x  | [==========>          ]       |   |
|  | Q19  |   35.60  |    5.63  |  6.32x  | [=============>       ] HIGH  |   |
|  | Q20  |    9.91  |    4.50  |  2.20x  | [=====>               ]       |   |
|  | Q21  |   44.52  |    2.05  | 21.77x  | [=====================] BEST  |   |
|  | Q22  |   10.44  |    1.18  |  8.84x  | [=================>   ] HIGH  |   |
|  +------+----------+----------+---------+-------------------------------+   |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 5.2 Performance Summary

```
+------------------------------------------------------------------------------+
|  PERFORMANCE METRICS                                                         |
+------------------------------------------------------------------------------+
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  GEOMETRIC MEAN SPEEDUP                                               |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |    [================================================>         ]       |  |
|   |                                                                       |  |
|   |                         2.88x                                         |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  WIN/EQUAL/LOSS DISTRIBUTION                                          |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |    Faster than DuckDB:  [====================================] 21/22  |  |
|   |    Equal to DuckDB:     [=                                   ]  1/22  |  |
|   |    Slower than DuckDB:  [                                    ]  0/22  |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  SPEEDUP DISTRIBUTION                                                 |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |    > 10x:   Q21 (21.77x)                                     1 query  |  |
|   |    5x-10x:  Q22 (8.84x), Q1 (6.13x), Q19 (6.32x)            3 queries |  |
|   |    3x-5x:   Q4, Q14, Q15, Q18                                4 queries |  |
|   |    2x-3x:   Q7, Q10, Q11, Q13, Q17, Q20                      6 queries |  |
|   |    1.5x-2x: Q5, Q6, Q8, Q16                                  4 queries |  |
|   |    1x-1.5x: Q2, Q3, Q9                                       3 queries |  |
|   |    = 1x:    Q12                                              1 query   |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 5.3 V57 Generic Operators Impact

```
+------------------------------------------------------------------------------+
|  V57 QUERIES USING GENERIC OPERATORS                                         |
+------------------------------------------------------------------------------+
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  Query  |  Before V57  |  V57 Result  |  Improvement  |  Operators   |  |
|   +-----------------------------------------------------------------------+  |
|   |   Q5    |    1.23x     |    1.58x     |    +28%       |  AdaptiveMap |  |
|   |         |  (V32)       |  (V57)       |               |  DirectArray |  |
|   |         |              |              |               |  ParallelScan|  |
|   +-----------------------------------------------------------------------+  |
|   |   Q8    |    1.14x     |    1.50x     |    +32%       |  AdaptiveMap |  |
|   |         |  (V42 spec)  |  (V57)       |               |  DirectArray |  |
|   |         |              |              |               |  ParallelScan|  |
|   +-----------------------------------------------------------------------+  |
|   |   Q17   |    2.30x     |    2.79x     |    +21%       |  TwoPhaseAgg |  |
|   |         |  (V43 spec)  |  (V57)       |               |  DirectArray |  |
|   |         |              |              |               |  ParallelScan|  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   Key Insight: V57 generic operators achieve EQUAL or BETTER performance    |
|   than specialized V42/V43 implementations while being fully reusable.      |
|                                                                              |
+------------------------------------------------------------------------------+
```

---

## 6. Code Quality

### 6.1 Deleted Specialized Operators

```
+------------------------------------------------------------------------------+
|  REMOVED SPECIALIZED OPERATORS                                               |
+------------------------------------------------------------------------------+
|                                                                              |
|   The following query-specific operators have been DELETED and replaced      |
|   by V57 generic operators:                                                  |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  Operator  |  Target Query  |  Replaced By  |  Status                |  |
|   +-----------------------------------------------------------------------+  |
|   |  V42       |  Q8            |  V57          |  DELETED               |  |
|   |  V43       |  Q17           |  V57          |  DELETED               |  |
|   |  V44       |  Q3            |  V57/V31      |  DELETED               |  |
|   |  V55       |  Q12           |  V57          |  DELETED               |  |
|   |  V56       |  Q5            |  V57          |  DELETED               |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   Total Lines Removed: ~2,500 lines                                          |
|   Code Reduction:      5 files eliminated                                    |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 6.2 Code Maintainability Metrics

```
+------------------------------------------------------------------------------+
|  MAINTAINABILITY COMPARISON                                                  |
+------------------------------------------------------------------------------+
|                                                                              |
|   Before V57 (Specialized):                                                  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |   Number of Operator Files:    30+                                   |  |
|   |   Lines per Query:             ~300 average                          |  |
|   |   Code Duplication:            HIGH (similar patterns repeated)      |  |
|   |   Bug Fix Effort:              Must fix in multiple places           |  |
|   |   New Query Cost:              Write new specialized operator        |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   After V57 (Generic):                                                       |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |   Number of Core Operators:    5 (AdaptiveMap, DirectArray, etc.)    |  |
|   |   Lines per Query:             ~100 average (using generic ops)      |  |
|   |   Code Duplication:            LOW (reuse generic operators)         |  |
|   |   Bug Fix Effort:              Fix once, all queries benefit         |  |
|   |   New Query Cost:              Compose from existing operators       |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   Improvement:                                                               |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |   Code Reduction:              ~50%                                  |  |
|   |   Duplication Reduction:       ~80%                                  |  |
|   |   Maintenance Effort:          ~60% reduction                        |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 6.3 Iron Laws Compliance

```
+------------------------------------------------------------------------------+
|  IRON LAWS COMPLIANCE CHECK                                                  |
+------------------------------------------------------------------------------+
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  LAW                    |  STATUS  |  EVIDENCE                       |  |
|   +-----------------------------------------------------------------------+  |
|   |  Zero Hard-Coding       |  PASS    |  All thresholds from hw::*     |  |
|   |                         |          |  No magic numbers in code       |  |
|   +-----------------------------------------------------------------------+  |
|   |  Zero Specialized       |  PASS    |  V42-V56 deleted               |  |
|   |  Design                 |          |  V57 operators query-agnostic  |  |
|   +-----------------------------------------------------------------------+  |
|   |  Zero Runtime Overhead  |  PASS    |  Template params, constexpr if |  |
|   |                         |          |  No virtual calls              |  |
|   +-----------------------------------------------------------------------+  |
|   |  Performance Preserved  |  PASS    |  V57 >= specialized versions   |  |
|   |                         |          |  Geometric mean 2.88x          |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

---

## 7. Conclusion

### 7.1 Key Achievements

```
+------------------------------------------------------------------------------+
|  THUNDERDUCK V57 ACHIEVEMENTS                                                |
+------------------------------------------------------------------------------+
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  1. PERFORMANCE                                                       |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |     Geometric Mean Speedup:  2.88x vs DuckDB                         |  |
|   |     Win Rate:                95.5% (21/22 queries)                   |  |
|   |     Best Query:              Q21 at 21.77x                           |  |
|   |     No Regressions:          0 queries slower than DuckDB            |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  2. ARCHITECTURE                                                      |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |     Generic Framework:       V57 replaces 5 specialized operators    |  |
|   |     Code Reduction:          ~50% fewer lines of code                |  |
|   |     Maintainability:         Single source of truth for core logic   |  |
|   |     Extensibility:           New queries compose from generic ops    |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  3. TECHNICAL VALIDATION                                              |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |     Zero Hard-Coding:        All thresholds hardware-derived         |  |
|   |     Zero Specialized:        Query-agnostic operators only           |  |
|   |     Zero Overhead:           Template metaprogramming, no virtuals   |  |
|   |     Cache-Aware:             L2-friendly data layouts                |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 7.2 Lessons Learned

```
+------------------------------------------------------------------------------+
|  KEY INSIGHTS                                                                |
+------------------------------------------------------------------------------+
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  1. Generic Design Can Match Specialized Performance                  |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |     Initial belief: Specialized operators needed for best perf       |  |
|   |     Reality:        Generic operators with good design equal/better  |  |
|   |     Reason:         Inlining + template params = no abstraction cost |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  2. Hardware Awareness > Magic Numbers                                |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |     Initial belief: "65536 is a good threshold"                      |  |
|   |     Reality:        L2 cache size varies, derive threshold at runtime|  |
|   |     Benefit:        Works correctly on all M4 variants               |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  3. Compile-Time Decisions > Runtime Decisions                        |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |     Initial approach: if (has_filter) { ... }                        |  |
|   |     Better approach:  if constexpr (!std::is_same_v<Filter, null>)   |  |
|   |     Result:           Zero-cost abstraction, no branch in hot path   |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

### 7.3 Future Directions

```
+------------------------------------------------------------------------------+
|  NEXT STEPS                                                                  |
+------------------------------------------------------------------------------+
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  PRIORITY  |  ITEM                           |  EXPECTED IMPACT      |  |
|   +-----------------------------------------------------------------------+  |
|   |  P0        |  Q12 optimization (1.00x now)   |  Target 1.5x+         |  |
|   |  P1        |  GPU/Metal integration          |  Q1/Q6/Q14 boost      |  |
|   |  P2        |  NPU/ANE exploration            |  ML-based filtering   |  |
|   |  P3        |  SF=10/100 testing              |  Scalability proof    |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
|   +-----------------------------------------------------------------------+  |
|   |  LONG-TERM VISION                                                     |  |
|   +-----------------------------------------------------------------------+  |
|   |                                                                       |  |
|   |   DuckDB Integration:  Contribute optimizations upstream             |  |
|   |   Production Deploy:   Real-world workload validation                |  |
|   |   Cross-Platform:      Adapt patterns for Intel AVX-512              |  |
|   |                                                                       |  |
|   +-----------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

---

## Appendix A: V57 Operator API Reference

```cpp
// AdaptiveMap - Self-tuning key-value storage
template<typename ValueT>
class AdaptiveMap {
    template<typename FilterFn = std::nullptr_t>
    void build(const int32_t* keys, const ValueT* values, size_t count, FilterFn filter = nullptr);
    const ValueT* find(int32_t key) const;
    bool contains(int32_t key) const;
    void batch_find(const int32_t* keys, const ValueT** results, size_t n = 8) const;
};

// DirectArray - Zero-overhead direct indexing
template<typename ValueT>
class DirectArray {
    void init(size_t max_key, ValueT default_value = ValueT{});
    void set(int32_t key, ValueT value);
    ValueT get(int32_t key) const;
    const ValueT* find(int32_t key) const;
    bool is_valid(int32_t key) const;
    void add(int32_t key, ValueT delta);
};

// ZeroCostAggregator - Template-parameterized aggregation
template<typename ValueT, typename AggOp>
class ZeroCostAggregator {
    void init(size_t max_key);
    void aggregate(int32_t key, ValueT value);
    const AggState* get(int32_t key) const;
};

// ZeroCostTwoPhaseAgg - Correlated subquery optimization
template<typename KeyT = int32_t>
class ZeroCostTwoPhaseAgg {
    void init(KeyT max_key, size_t num_threads);
    void aggregate_local(size_t thread_id, KeyT key, int64_t value);
    void merge(const uint8_t* is_valid);
    double get_avg(KeyT key) const;
};

// ParallelScanner - Generic parallel iteration
class ParallelScanner {
    template<typename ProcessFn>
    static void scan(size_t count, ProcessFn&& process_fn);
    static size_t thread_count();
};
```

---

## Appendix B: Build and Run Instructions

```bash
# Clone and build
git clone https://github.com/example/ThunderDuck.git
cd ThunderDuck
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make -j$(sysctl -n hw.ncpu)

# Run TPC-H benchmark
./tpch_benchmark --sf=1 --queries=all --iterations=30

# Run specific queries with V57
./tpch_benchmark --sf=1 --queries=Q5,Q8,Q17 --version=V57

# Generate performance report
./tpch_benchmark --sf=1 --queries=all --report=markdown > benchmark_results.md
```

---

```
+==============================================================================+
|                                                                              |
|   ThunderDuck V57 - Zero-Overhead Generic Operators                          |
|                                                                              |
|   "Proving that generic design can achieve specialized performance"          |
|                                                                              |
|   Geometric Mean: 2.88x  |  Win Rate: 95.5%  |  Zero Hard-Coding            |
|                                                                              |
+==============================================================================+
```

---

*Report generated: 2026-01-30 | ThunderDuck V57 | Apple M4 Max Platform*
