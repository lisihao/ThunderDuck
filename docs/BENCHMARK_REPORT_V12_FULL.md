# ThunderDuck V12/V12.1 全面性能基准测试报告

> **版本标签**: V12.1 - 统一最优版
> **测试日期**: 2026-01-27
> **测试平台**: Apple M4 Max | macOS 14.x

---

## 一、测试概述

### 1.1 测试目标

对比 ThunderDuck 各版本 (V3, V7, V8, V9, V10, V11, V12, V12.1) 与 DuckDB 原版的性能，找出各算子在不同数据规模下的最优实现。

### 1.2 测试环境

| 项目 | 配置 |
|------|------|
| CPU | Apple M4 Max (16 核) |
| GPU | Apple M4 Max GPU (40 核) |
| 内存 | 64 GB 统一内存 (UMA) |
| 理论带宽 | ~400 GB/s |
| 操作系统 | macOS 14.x |
| 编译器 | clang++ -O3 -mcpu=native |

---

## 二、FILTER 算子测试

### 2.1 SQL 与配置

```sql
SELECT COUNT(*) FROM t WHERE value > 500000
```

- **数据类型**: INT32
- **选择率**: ~50%

### 2.2 1M 数据测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU 标量 | 0.27 | 13.71 | 1.00x | 7.33x | 基准 |
| V3 | CPU SIMD | 0.04 | 100.46 | **7.33x** | 1.00x | |
| V7 | GPU Metal | 0.04 | 99.96 | **7.29x** | 1.00x | |
| V9 | CPU SIMD+ | 0.04 | 100.08 | **7.30x** | 1.00x | |
| **V12** | GPU Metal | 0.04 | 103.36 | **7.54x** | 1.03x | ★最优 |

**分析**: V12 使用 GPU 在 1M 数据上达到 **7.54x**，是最优选择。

### 2.3 10M 数据测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU 标量 | 1.45 | 25.75 | 1.00x | 3.02x | 基准 |
| **V3** | CPU SIMD | 0.48 | 77.79 | **3.02x** | 1.00x | ★最优 |
| V7 | GPU Metal | 0.49 | 76.73 | **2.98x** | 0.99x | |
| V9 | CPU SIMD+ | 0.52 | 72.25 | **2.81x** | 0.93x | |
| V12 | GPU Metal | 0.54 | 69.58 | **2.70x** | 0.89x | |

**分析**: 在 10M 数据上，V3 CPU SIMD (**3.02x**) 比 GPU 版本更快，带宽利用率接近内存极限。

---

## 三、AGGREGATE 算子测试

### 3.1 SQL 与配置

```sql
SELECT SUM(value) FROM t
```

- **数据类型**: INT32 → INT64
- **算法**: 向量化归约

### 3.2 1M 数据测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V2 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU 标量 | 0.25 | 14.89 | 1.00x | 5.31x | 基准 |
| V2 | CPU SIMD | 0.05 | 79.05 | **5.31x** | 1.00x | |
| V7 | GPU Metal | 0.04 | 86.20 | **5.79x** | 1.09x | |
| **V9** | CPU SIMD+ | 0.04 | 86.77 | **5.83x** | 1.10x | ★最优 |
| V12 | GPU Metal | 0.04 | 85.92 | **5.77x** | 1.09x | |

### 3.3 10M 数据测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V2 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU 标量 | 1.66 | 22.44 | 1.00x | 2.55x | 基准 |
| V2 | CPU SIMD | 0.65 | 57.24 | **2.55x** | 1.00x | |
| **V7** | GPU Metal | 0.55 | 67.56 | **3.01x** | 1.18x | ★最优 |
| V9 | CPU SIMD+ | 0.60 | 61.67 | **2.75x** | 1.08x | |
| V12 | GPU Metal | 0.58 | 64.07 | **2.85x** | 1.12x | |

---

## 四、GROUP BY 算子测试

### 4.1 SQL 与配置

```sql
SELECT group_id, SUM(value) FROM t GROUP BY group_id
```

- **数据类型**: (UINT32, INT32) → INT64
- **分组数量**: 1000

### 4.2 1M 数据测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V7 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU 标量 | 0.61 | 12.27 | 1.00x | 2.28x | 基准 |
| V7 | CPU 单线程 | 0.27 | 27.96 | **2.28x** | 1.00x | |
| **V8** | CPU 4核并行 | 0.14 | 54.85 | **4.47x** | 1.96x | ★最优 |
| V9 | GPU 两阶段原子 | 0.94 | 7.95 | 0.65x | 0.28x | GPU效率低 |
| V12.1 | GPU Warp-level | 0.71 | 10.44 | 0.85x | 0.37x | +31%改进 |
| V12 | CPU Parallel | 0.15 | 50.49 | **4.11x** | 1.81x | |

**V12.1 GPU 优化分析**:
- V9 GPU (两阶段原子): 0.65x
- V12.1 GPU (Warp-level): 0.85x
- **GPU 改进幅度: +31%**

### 4.3 10M 数据测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V7 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU 标量 | 2.55 | 29.18 | 1.00x | 0.91x | 基准 |
| V7 | CPU 单线程 | 2.81 | 26.56 | 0.91x | 1.00x | 劣于DuckDB |
| **V8** | CPU 4核并行 | 1.10 | 67.81 | **2.32x** | 2.55x | ★最优 |
| V9 | GPU 两阶段原子 | 3.07 | 24.29 | 0.83x | 0.91x | |
| V12.1 | GPU Warp-level | 3.86 | 19.31 | 0.66x | 0.73x | GPU效率下降 |
| V12 | CPU Parallel | 1.24 | 60.29 | **2.07x** | 2.27x | |

**分析**: GROUP BY 算子中 CPU 多线程 (V8) 始终是最优选择，GPU 版本受限于原子操作开销。

---

## 五、TopK 算子测试

### 5.1 SQL 与配置

```sql
SELECT * FROM t ORDER BY value DESC LIMIT 10
```

- **K 值**: 10
- **数据类型**: INT32

### 5.2 1M 数据测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU Sort | 0.81 | 4.61 | 1.00x | 1.78x | 基准 |
| V3 | CPU Heap | 0.45 | 8.21 | **1.78x** | 1.00x | |
| V7 | CPU Sampling | 0.06 | 59.60 | **12.94x** | 7.26x | |
| **V8** | CPU Count-Based | 0.06 | 61.54 | **13.36x** | 7.50x | ★最优 |
| V12 | CPU Count-Based | 0.09 | 41.33 | **8.97x** | 5.03x | |

### 5.3 10M 数据测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU Sort | 2.73 | 13.62 | 1.00x | 0.60x | 基准 |
| V3 | CPU Heap | 4.59 | 8.12 | 0.60x | 1.00x | 劣于DuckDB |
| **V7** | CPU Sampling | 0.53 | 69.80 | **5.12x** | 8.59x | ★最优 |
| V8 | CPU Count-Based | 0.54 | 69.17 | **5.08x** | 8.52x | |
| V12 | CPU Count-Based | 0.55 | 67.55 | **4.96x** | 8.32x | |

**分析**: TopK 是 ThunderDuck 最大优势场景，V7/V8 算法避免完整排序，达到 **5-13x** 加速。

---

## 六、HASH JOIN 算子测试

### 6.1 SQL 与配置

```sql
SELECT * FROM build_t INNER JOIN probe_t ON build_t.key = probe_t.key
```

- **Build 表**: 100K 行
- **Probe 表**: 1M 行
- **匹配率**: ~10%

### 6.2 测试结果

| 版本 | 设备 | 时间(ms) | 吞吐(GB/s) | vs DuckDB | vs V3 | 状态 |
|------|------|----------|------------|-----------|-------|------|
| DuckDB | CPU 标量 | 1.94 | 2.12 | 1.00x | 1.61x | 基准 |
| **V3** | CPU Radix | 1.20 | 3.41 | **1.61x** | 1.00x | ★最优 |
| V6 | CPU Prefetch | 1.37 | 3.00 | **1.42x** | 0.88x | |
| V7 | CPU/GPU Adaptive | 1.33 | 3.08 | **1.46x** | 0.90x | |
| V10 | CPU Full Semantic | 1.27 | 3.22 | **1.52x** | 0.94x | |
| V11 | CPU SIMD Probe | 3.35 | 1.22 | 0.58x | 0.36x | 性能下降 |
| V12 | CPU SIMD | 2.89 | 1.42 | 0.67x | 0.42x | |

**分析**: Hash Join 测试显示 V3 Radix 实现在低匹配率场景下表现最优，V11/V12 的 SIMD 优化在此场景下效果不佳。

---

## 七、各版本最优性能汇总

### 7.1 最优版本矩阵

| 算子 | 数据规模 | 最优版本 | vs DuckDB | 设备 |
|------|----------|----------|-----------|------|
| **Filter** | 1M | V12 | **7.54x** | GPU Metal |
| **Filter** | 10M | V3 | **3.02x** | CPU SIMD |
| **Aggregate** | 1M | V9 | **5.83x** | CPU SIMD+ |
| **Aggregate** | 10M | V7 | **3.01x** | GPU Metal |
| **GROUP BY** | 1M | V8 | **4.47x** | CPU 4核 |
| **GROUP BY** | 10M | V8 | **2.32x** | CPU 4核 |
| **TopK** | 1M | V8 | **13.36x** | CPU Count-Based |
| **TopK** | 10M | V7 | **5.12x** | CPU Sampling |
| **Hash Join** | 100K×1M | V3 | **1.61x** | CPU Radix |

### 7.2 V12 统一版本表现

| 算子 | 1M 性能 | 10M 性能 | 是否最优 |
|------|---------|----------|----------|
| Filter | 7.54x | 2.70x | 1M ★最优 |
| Aggregate | 5.77x | 2.85x | 接近最优 |
| GROUP BY | 4.11x | 2.07x | 接近最优 |
| TopK | 8.97x | 4.96x | 接近最优 |
| Hash Join | 0.67x | - | 需要优化 |

---

## 八、优化建议

### 8.1 已完成优化

- [x] V12.1 GPU GROUP BY Warp-level reduction (1M +31%)
- [x] Filter/Aggregate 自适应策略选择

### 8.2 待优化项

| 优先级 | 算子 | 当前 | 目标 | 方案 |
|--------|------|------|------|------|
| **P0** | Hash Join V11/V12 | 0.67x | 1.5x+ | 回退到 V3 Radix 或优化 SIMD 版本 |
| **P1** | Filter 10M | 2.70x | 3.0x+ | 使用 CPU V3 替代 GPU |
| **P2** | GROUP BY GPU | 0.66x | 2.0x+ | 进一步优化原子操作 |
| **P3** | TopK V12 | 8.97x | 13x+ | 减少路由开销 |

### 8.3 V12 策略调整建议

```cpp
// 推荐策略矩阵
| 算子      | 小数据 (<1M) | 大数据 (>=1M) |
|-----------|-------------|---------------|
| Filter    | GPU (V12)   | CPU V3        |
| Aggregate | V9 CPU      | V7 GPU        |
| TopK      | V8 Count    | V7/V8         |
| GROUP BY  | V8 CPU 4核  | V8 CPU 4核    |
| Hash Join | V3 Radix    | V3 Radix      |
```

---

## 九、文件清单

| 文件 | 说明 |
|------|------|
| `benchmark/v12_full_benchmark.cpp` | V12/V12.1 全面基准测试 |
| `src/core/v12_unified.cpp` | V12 智能路由实现 |
| `src/gpu/group_aggregate_v3.mm` | V12.1 GPU GROUP BY Warp-level |
| `docs/BENCHMARK_REPORT_V12_FULL.md` | 本报告 |

---

## 十、结论

1. **TopK** 是 ThunderDuck 最大优势场景，达到 **5-13x** 加速
2. **Filter/Aggregate** 达到 **3-7x** 加速，接近内存带宽极限
3. **GROUP BY** V8 CPU 多线程是最优选择，GPU 版本受原子操作限制
4. **Hash Join** V3 Radix 在低匹配率场景最优，V11/V12 SIMD 版本需要进一步优化

**V12 作为统一版本，提供了良好的开箱即用体验，但在特定场景下仍有优化空间。**
