# ThunderDuck V24 性能优化报告

> 日期: 2026-01-28 | 基于 TPC-H SF=1 测试

## 一、V24 优化内容

### P0: 选择向量替换中间 vector
- 使用索引数组 (SelectionVector) 代替数据复制
- 减少内存分配和数据移动

### P1: 数组替换 hash 表
- 小基数分组使用直接数组
- Q1 GROUP BY (6 groups) 使用数组聚合

### P2: Filter + Join 融合
- 在 hash probe 过程中同时检查过滤条件
- 减少一次完整遍历

## 二、测试结果

### 2.1 查询级别对比

| Query | V23 | V24 | 变化 | 说明 |
|-------|-----|-----|------|------|
| Q1 | 6.38x | 6.44x | = | 保持不变 |
| Q3 | 0.32x | 0.29x | -9% | V24 hash-based 实现 |
| Q5 | 0.26x | **0.53x** | **+104%** | V24 优化有效 |
| Q6 | 1.44x | 1.51x | +5% | 使用原版 (多线程+8路展开) |
| Q9 | 0.42x | 0.43x | +2% | 使用原版 |
| Q10 | 1.16x | 1.11x | -4% | 保持不变 |

### 2.2 整体统计

| 指标 | V23 | V24 | 变化 |
|------|-----|-----|------|
| 加速查询数 | 4 | 5 | +1 |
| 几何平均 | 0.84x | 0.85x | +1% |
| Category A 平均 | 1.20x | 1.21x | +1% |

## 三、关键发现

### 3.1 V24 优化对 Q5 有效
Q5 从 0.26x 提升到 0.53x (+104%)，原因:
- 移除了线程创建开销 (8 threads → single thread)
- 使用 hash-based 直接聚合替代 JOIN + 循环
- 减少中间数据结构

### 3.2 V24 优化对 Q3 效果有限
Q3 从 0.32x 变为 0.29x (-9%)，原因:
- Q3 的 JOIN 结果集较大，hash 查找开销高
- 仍需要多次遍历数据

### 3.3 线程创建开销显著
对于 SF=1 规模的数据:
- 线程创建/销毁开销约 0.1-0.5ms
- 对于 2-10ms 的查询，这是显著的开销
- Q6 使用多线程仍然有效，因为计算量大

## 四、架构限制

```
┌─────────────────────────────────────────────────────────┐
│              当前 ThunderDuck 执行模式                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│   DuckDB 内部格式 ──▶ 提取到内存数组 (开销 20-30%)      │
│            │                                             │
│            ▼                                             │
│   Filter/Join/Agg 算子 (ThunderDuck 快 2-11x)           │
│            │                                             │
│            ▼                                             │
│   中间结果物化 (开销 30-40%)                            │
│            │                                             │
│            ▼                                             │
│   最终结果                                               │
│                                                          │
│   结论: 算子加速被数据移动开销抵消                       │
└─────────────────────────────────────────────────────────┘
```

## 五、下一步优化建议

### 短期 (已完成部分)
- [x] P0: 选择向量
- [x] P1: 数组聚合
- [x] P2: Filter+Join 融合
- 效果: Q5 +104%, 整体 +1%

### 中期 (建议)
1. **真正的晚期物化**
   - 所有算子使用选择向量工作
   - 只在最终输出时才物化数据

2. **选择性列提取**
   - 只从 DuckDB 提取需要的列
   - 避免一次性提取所有列

### 长期 (建议)
1. **DuckDB Extension 集成**
   - 直接在 DuckDB 的 Vector 上执行算子
   - 零拷贝，无中间结果

2. **查询级别代码生成**
   - 针对高频查询模式生成融合代码
   - 单遍扫描完成所有操作

## 六、结论

V24 优化在算法层面有效 (Q5 +104%)，但受限于数据提取架构，整体改善有限 (+1%)。

要实现显著加速 (>1.5x)，需要:
1. 深度集成 DuckDB (Extension 模式)
2. 或重新设计数据流水线

---

*ThunderDuck V24 性能优化报告 - 2026-01-28*
